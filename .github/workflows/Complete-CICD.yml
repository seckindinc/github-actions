name: Complete CI/CD Pipeline

on:
  push:
    branches: [main]  # Trigger the complete CI/CD pipeline on main branch pushes

jobs:
  # CONTINUOUS INTEGRATION STAGE
  continuous-integration:
    name: Code Quality Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install black
      run: pip install black

    - name: Check formatting
      run: black --check .

  # CONTINUOUS DEPLOYMENT STAGE 1: Development Environment
  deploy-development:
    name: Development Deployment
    runs-on: ubuntu-latest
    needs: continuous-integration  # Only deploy if CI validation passes
    environment: dev
    
    steps:
    - name: Checkout validated code
      uses: actions/checkout@v4

    - name: Execute development deployment
      run: |
        export ENVIRONMENT="${{ vars.ENVIRONMENT }}"
        python sample-CD.py

  # CONTINUOUS DEPLOYMENT STAGE 2: Test Environment
  deploy-test:
    name: Test Environment Deployment
    runs-on: ubuntu-latest
    needs: [continuous-integration, deploy-development]  # Requires both CI success and dev deployment
    environment: test
    
    steps:
    - name: Checkout validated code
      uses: actions/checkout@v4

    - name: Execute test deployment
      run: |
        export ENVIRONMENT="${{ vars.ENVIRONMENT }}"
        python sample-CD.py

  # PIPELINE SUMMARY
  pipeline-summary:
    name: Pipeline Completion Summary  
    runs-on: ubuntu-latest
    needs: [continuous-integration, deploy-development, deploy-test]
    if: always()
    
    steps:
    - name: Generate pipeline summary
      run: |
        echo "## CI/CD Pipeline Execution Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Pipeline Trigger:** Push to main branch" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Stage Results:" >> $GITHUB_STEP_SUMMARY
        
        # Check CI status
        if [[ "${{ needs.continuous-integration.result }}" == "success" ]]; then
          echo "- Continuous Integration: Code quality validation passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "- Continuous Integration: Code quality validation failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Check Development Deployment status  
        if [[ "${{ needs.deploy-development.result }}" == "success" ]]; then
          echo "- Development Deployment: Successfully deployed" >> $GITHUB_STEP_SUMMARY
        elif [[ "${{ needs.deploy-development.result }}" == "skipped" ]]; then
          echo "- Development Deployment: Skipped due to CI failure" >> $GITHUB_STEP_SUMMARY
        else
          echo "- Development Deployment: Deployment failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Check Test Deployment status
        if [[ "${{ needs.deploy-test.result }}" == "success" ]]; then
          echo "- Test Deployment: Successfully deployed with approval" >> $GITHUB_STEP_SUMMARY
        elif [[ "${{ needs.deploy-test.result }}" == "skipped" ]]; then
          echo "- Test Deployment: Skipped due to previous stage failure" >> $GITHUB_STEP_SUMMARY
        else
          echo "- Test Deployment: Deployment failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Determine next steps based on overall success
        if [[ "${{ needs.continuous-integration.result }}" == "success" && "${{ needs.deploy-development.result }}" == "success" && "${{ needs.deploy-test.result }}" == "success" ]]; then
          echo "**Next Steps:** Code is ready for production deployment consideration" >> $GITHUB_STEP_SUMMARY
        else
          echo "**Next Steps:** Review failed stages and address issues before retry" >> $GITHUB_STEP_SUMMARY
        firesult }}" == "success" && "${{ needs.deploy-development.result }}" == "success" && "${{ needs.deploy-test.result }}" == "success" ]]; then
          echo "**Next Steps:** Code is ready for production deployment consideration" >> $GITHUB_STEP_SUMMARY
        else
          echo "**Next Steps:** Review failed stages and address issues before retry" >> $GITHUB_STEP_SUMMARY
        fi